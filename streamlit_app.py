import streamlit as st
import pandas as pd
import plotly.express as px
from pathlib import Path

st.set_page_config(
    page_title="ì—°ë ¹ëŒ€ë³„ ë…ì„œ ë°ì´í„° ëŒ€ì‹œë³´ë“œ",
    layout="wide"
)

DATA_DIR = Path(".")

# ---------------------------------------
# 1. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
# ---------------------------------------
@st.cache_data
def load_read_time():
    """ì¼ë…ì„œì‹œê°„.csvì—ì„œ ì—°ë ¹ë³„(ì„±ì¸, ì¢…ì´ì±…, í‰ì¼ ê¸°ì¤€) ë°ì´í„°ë§Œ ì¶”ì¶œ"""
    path = DATA_DIR / "ì¼ë…ì„œì‹œê°„.csv"
    df = pd.read_csv(path)

    # ì—°ë ¹ ë°ì´í„°ë§Œ í•„í„°
    df = df[df["FLAG_NM"] == "ì—°ë ¹"].copy()

    # ì„±ì¸ ì¢…ì´ì±…, í‰ì¼(HLDY_AT = 'N')ë§Œ ì‚¬ìš©
    df = df[(df["BOOK_TY_NM"] == "ì¢…ì´ì±…") & (df["HLDY_AT"] == "N")].copy()

    # ì„±ì¸ ë‚˜ì´ëŒ€ë§Œ ë‚¨ê¸°ê¸° (í•„ìš”í•˜ë©´ ì—¬ê¸° ì¡°ì •)
    target_ages = ["19-29ì„¸", "30-39ì„¸", "40-49ì„¸", "50-59ì„¸", "60ì„¸ì´ìƒ"]
    df = df[df["FLAG_VALUE"].isin(target_ages)].copy()

    # ì»¬ëŸ¼ ì´ë¦„ ì •ë¦¬
    df = df.rename(columns={
        "FLAG_VALUE": "ì—°ë ¹ëŒ€",
        "AVRG_READ_MNT_VALUE": "ì¼í‰ê· _ë…ì„œì‹œê°„(ë¶„)",
        "NON_READ_RT": "ë¹„ë…ì„œìœ¨(%)",
        "THIRTY_MNT_BELO_READ_RT": "30ë¶„_ë¯¸ë§Œ(%)",
        "ONE_TIME_BELO_READ_RT": "1ì‹œê°„_ë¯¸ë§Œ(%)",
        "TWO_TIME_BELO_READ_RT": "2ì‹œê°„_ë¯¸ë§Œ(%)",
        "THREE_TIME_BELO_READ_RT": "3ì‹œê°„_ë¯¸ë§Œ(%)",
        "FOUR_TIME_BELO_READ_RT": "4ì‹œê°„_ë¯¸ë§Œ(%)",
        "FIVE_TIME_BELO_READ_RT": "5ì‹œê°„_ë¯¸ë§Œ(%)",
        "FIVE_TIME_ABOVE_READ_RT": "5ì‹œê°„_ì´ìƒ(%)"
    })

    return df


@st.cache_data
def load_read_amount():
    """ë…ì„œëŸ‰ë°ì´í„°.csvì—ì„œ ì—°ë ¹ë³„ ì—°ê°„ ë…ì„œëŸ‰(ê¶Œìˆ˜) ë°ì´í„° ì •ë¦¬"""
    path = DATA_DIR / "ë…ì„œëŸ‰ë°ì´í„°.csv"
    df = pd.read_csv(path)

    # ì²« ë²ˆì§¸ í–‰(0ë²ˆ row)ì´ 'ì‚¬ë¡€ìˆ˜/ì „ì²´ í‰ê· ' ë“±ì˜ ì„¤ëª…ì´ë¼ì„œ ì œê±°
    df = df.iloc[1:].copy()

    # ì—°ë ¹ë³„ë§Œ ì‚¬ìš©
    df = df[df["í†µê³„ë¶„ë¥˜(1)"] == "ì—°ë ¹ë³„"].copy()

    # ì»¬ëŸ¼ëª… ê·¸ëŒ€ë¡œ ë‘ë˜, ì „ì²´ í‰ê· ë§Œ ì‚¬ìš© (2019.1, 2021.1)
    df = df.rename(columns={
        "í†µê³„ë¶„ë¥˜(2)": "ì—°ë ¹ëŒ€",
        "2019.1": "2019_ì „ì²´í‰ê· (ê¶Œ)",
        "2021.1": "2021_ì „ì²´í‰ê· (ê¶Œ)"
    })

    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ
    df = df[["ì—°ë ¹ëŒ€", "2019_ì „ì²´í‰ê· (ê¶Œ)", "2021_ì „ì²´í‰ê· (ê¶Œ)"]]

    # long í˜•íƒœë¡œ ë³€í™˜ (ì—°ë„ë³„ ê·¸ë˜í”„ í¸í•˜ê²Œ ê·¸ë¦¬ê¸°)
    tidy = df.melt(
        id_vars="ì—°ë ¹ëŒ€",
        var_name="ì—°ë„",
        value_name="ì—°ê°„_ë…ì„œëŸ‰(ê¶Œ)"
    )
    tidy["ì—°ë„"] = tidy["ì—°ë„"].str.extract(r"(\d{4})").astype(int)

    return tidy


@st.cache_data
def load_genre_preference():
    """ì—°ë ¹ëŒ€ë³„ë…ì„œì„ í˜¸ë„.csvì—ì„œ ì—°ë ¹ë³„ ë…ì„œ 'ì¢‹ì•„í•¨ ì •ë„' ë¶„í¬"""
    path = DATA_DIR / "ì—°ë ¹ëŒ€ë³„ë…ì„œì„ í˜¸ë„.csv"
    # cp949 ì¸ì½”ë”©
    df = pd.read_csv(path, encoding="cp949")

    # 0ë²ˆ row: í•­ëª© ì„¤ëª…, 1ë²ˆ ì´í›„: ì‹¤ì œ ë°ì´í„°
    meta = df.iloc[0].copy()
    df = df.iloc[1:].copy()

    # ì—°ë ¹ë³„ë§Œ ì‚¬ìš©
    df = df[df["í†µê³„ë¶„ë¥˜(1)"] == "ì—°ë ¹ë³„"].copy()

    # ê°€ë…ì„± ìˆê²Œ ì»¬ëŸ¼ ì´ë¦„ ë°”ê¾¸ê¸°
    df = df.rename(columns={
        "í†µê³„ë¶„ë¥˜(2)": "ì—°ë ¹ëŒ€"
    })

    # 'ë§¤ìš° ì¢‹ì•„í•¨', 'ì•½ê°„ ì¢‹ì•„í•¨' ë“± ë¼ë²¨ ê°€ì ¸ì˜¤ê¸° (metaì—ì„œ)
    like_labels = {
        "2023.1": meta["2023.1"],
        "2023.2": meta["2023.2"],
        "2023.3": meta["2023.3"],
        "2023.4": meta["2023.4"],
        "2023.5": meta["2023.5"]
    }

    # Tidy ë³€í™˜
    tidy = df.melt(
        id_vars=["ì—°ë ¹ëŒ€"],
        value_vars=list(like_labels.keys()),
        var_name="êµ¬ë¶„ì½”ë“œ",
        value_name="ë¹„ìœ¨(%)"
    )

    tidy["ì„ í˜¸ë„"] = tidy["êµ¬ë¶„ì½”ë“œ"].map(like_labels)
    tidy["ë¹„ìœ¨(%)"] = tidy["ë¹„ìœ¨(%)"].astype(float)

    return tidy


@st.cache_data
def load_barrier():
    """ë…ì„œì¥ì• ìš”ì¸.xlsxì—ì„œ ì—°ë ¹ë³„ ë…ì„œ ì¥ì• ìš”ì¸ ë¹„ìœ¨"""
    path = DATA_DIR / "ë…ì„œì¥ì• ìš”ì¸.xlsx"
    df = pd.read_excel(path)

    meta = df.iloc[0].copy()
    df = df.iloc[1:].copy()

    # ì—°ë ¹ë³„ë§Œ ì‚¬ìš© (ì§€ê¸ˆ íŒŒì¼ì—ëŠ” 20ëŒ€ ì´í•˜ë§Œ ìˆìŒ)
    df = df[df["í†µê³„ë¶„ë¥˜(1)"] == "ì—°ë ¹ë³„"].copy()
    df = df.rename(columns={"í†µê³„ë¶„ë¥˜(2)": "ì—°ë ¹ëŒ€"})

    # ì´ìœ ë“¤ ë¼ë²¨ (2023.1 ~ 2023.9)
    reason_labels = {
        "2023.1": meta["2023.1"],
        "2023.2": meta["2023.2"],
        "2023.3": meta["2023.3"],
        "2023.4": meta["2023.4"],
        "2023.5": meta["2023.5"],
        "2023.6": meta["2023.6"],
        "2023.7": meta["2023.7"],
        "2023.8": meta["2023.8"],
        "2023.9": meta["2023.9"],
    }

    tidy = df.melt(
        id_vars=["ì—°ë ¹ëŒ€"],
        value_vars=list(reason_labels.keys()),
        var_name="êµ¬ë¶„ì½”ë“œ",
        value_name="ë¹„ìœ¨(%)"
    )

    tidy["ì¥ì• ìš”ì¸"] = tidy["êµ¬ë¶„ì½”ë“œ"].map(reason_labels)
    tidy["ë¹„ìœ¨(%)"] = tidy["ë¹„ìœ¨(%)"].astype(float)

    return tidy


# ---------------------------------------
# 2. ê³µí†µ ì—°ë ¹ëŒ€ ë§¤í•‘ (ëŒ€ì‹œë³´ë“œì—ì„œ ë³´ì—¬ì¤„ ì„ íƒ ê°’)
# ---------------------------------------
AGE_OPTIONS = [
    "20ëŒ€(19~29ì„¸)",
    "30ëŒ€(30~39ì„¸)",
    "40ëŒ€(40~49ì„¸)",
    "50ëŒ€(50~59ì„¸)",
    "60ëŒ€ ì´ìƒ"
]

# ê° ë°ì´í„°ì…‹ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë‚˜ì´ í‘œí˜„ê³¼ ë§¤í•‘
AGE_MAP_READ_AMOUNT = {
    "20ëŒ€(19~29ì„¸)": "19~29ì„¸",
    "30ëŒ€(30~39ì„¸)": "30~39ì„¸",
    "40ëŒ€(40~49ì„¸)": "40~49ì„¸",
    "50ëŒ€(50~59ì„¸)": "50~59ì„¸",
    "60ëŒ€ ì´ìƒ": "60ì„¸ ì´ìƒ"
}

AGE_MAP_READ_TIME = {
    "20ëŒ€(19~29ì„¸)": "19-29ì„¸",
    "30ëŒ€(30~39ì„¸)": "30-39ì„¸",
    "40ëŒ€(40~49ì„¸)": "40-49ì„¸",
    "50ëŒ€(50~59ì„¸)": "50-59ì„¸",
    "60ëŒ€ ì´ìƒ": "60ì„¸ì´ìƒ"
}

AGE_MAP_GENRE = {
    "20ëŒ€(19~29ì„¸)": "20ëŒ€ ì´í•˜",
    "30ëŒ€(30~39ì„¸)": "30ëŒ€",
    "40ëŒ€(40~49ì„¸)": "40ëŒ€",
    "50ëŒ€(50~59ì„¸)": "50ëŒ€",
    "60ëŒ€ ì´ìƒ": "60ëŒ€ ì´ìƒ"
}

AGE_MAP_BARRIER = {
    "20ëŒ€(19~29ì„¸)": "20ëŒ€ ì´í•˜"   # íŒŒì¼ì— ì§€ê¸ˆì€ 20ëŒ€ ì´í•˜ë§Œ ìˆìŒ
    # ë‹¤ë¥¸ ì—°ë ¹ëŒ€ê°€ ì¶”ê°€ë˜ë©´ ì—¬ê¸° í™•ì¥
}


# ---------------------------------------
# 3. ë©”ì¸ ì•±
# ---------------------------------------
def main():
    st.title("ğŸ“š ì—°ë ¹ëŒ€ë³„ ë…ì„œ ë°ì´í„° ëŒ€ì‹œë³´ë“œ")

    st.markdown("""
    ì´ ëŒ€ì‹œë³´ë“œëŠ” **ì—°ë ¹ëŒ€ë³„ ë…ì„œëŸ‰, ì¼ë…ì„œì‹œê°„, ë…ì„œì„ í˜¸ë„, ë…ì„œ ì¥ì• ìš”ì¸** ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ  
    íŠ¹íˆ **20ëŒ€ ë…ì„œì˜ ì˜ë¯¸**ë¥¼ ì‚´í´ë³´ê¸° ìœ„í•´ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
    """)

    # ë°ì´í„° ë¡œë“œ
    read_time = load_read_time()
    read_amount = load_read_amount()
    genre_pref = load_genre_preference()
    barrier = load_barrier()

    # ì‚¬ì´ë“œë°”: ì—°ë ¹ëŒ€ ì„ íƒ
    st.sidebar.header("ì—°ë ¹ëŒ€ ì„ íƒ")
    selected_age = st.sidebar.selectbox("ë¶„ì„í•  ì—°ë ¹ëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”", AGE_OPTIONS, index=0)

    # KPI ì¹´ë“œ (ë…ì„œëŸ‰ + ì¼ë…ì„œì‹œê°„)
    col1, col2, col3 = st.columns(3)

    # ì„ íƒ ì—°ë ¹ëŒ€ì— í•´ë‹¹í•˜ëŠ” ê°’ ì°¾ê¸°
    # ë…ì„œëŸ‰: 2021 ê¸°ì¤€ ì „ì²´í‰ê· 
    amt_age_label = AGE_MAP_READ_AMOUNT[selected_age]
    latest_amt = read_amount[
        (read_amount["ì—°ë ¹ëŒ€"] == amt_age_label) & (read_amount["ì—°ë„"] == 2021)
    ]["ì—°ê°„_ë…ì„œëŸ‰(ê¶Œ)"]

    # ì¼ë…ì„œì‹œê°„
    time_age_label = AGE_MAP_READ_TIME[selected_age]
    latest_time_row = read_time[read_time["ì—°ë ¹ëŒ€"] == time_age_label]

    with col1:
        if not latest_amt.empty:
            st.metric(
                label=f"{selected_age} ì—°ê°„ ë…ì„œëŸ‰(2021, ì „ì²´ í‰ê· )",
                value=f"{latest_amt.iloc[0]:.1f} ê¶Œ"
            )
        else:
            st.metric(
                label=f"{selected_age} ì—°ê°„ ë…ì„œëŸ‰",
                value="ë°ì´í„° ì—†ìŒ"
            )

    with col2:
        if not latest_time_row.empty:
            st.metric(
                label=f"{selected_age} 1ì¼ í‰ê·  ë…ì„œì‹œê°„",
                value=f"{latest_time_row['ì¼í‰ê· _ë…ì„œì‹œê°„(ë¶„)'].iloc[0]:.1f} ë¶„",
                delta=f"ë¹„ë…ì„œìœ¨ {latest_time_row['ë¹„ë…ì„œìœ¨(%)'].iloc[0]:.1f}%"
            )
        else:
            st.metric(
                label=f"{selected_age} 1ì¼ í‰ê·  ë…ì„œì‹œê°„",
                value="ë°ì´í„° ì—†ìŒ"
            )

    with col3:
        # ì„ í˜¸ë„ ìš”ì•½ (ë§¤ìš°+ì•½ê°„ ì¢‹ì•„í•¨ í•©ê³„)
        genre_age_label = AGE_MAP_GENRE[selected_age]
        sub = genre_pref[genre_pref["ì—°ë ¹ëŒ€"] == genre_age_label]
        if not sub.empty:
            like_sum = sub[sub["ì„ í˜¸ë„"].isin(["ë§¤ìš° ì¢‹ì•„í•¨", "ì•½ê°„ ì¢‹ì•„í•¨"])]["ë¹„ìœ¨(%)"].sum()
            st.metric(
                label=f"{selected_age} 'ë…ì„œë¥¼ ì¢‹ì•„í•¨' ë¹„ìœ¨",
                value=f"{like_sum:.1f} %"
            )
        else:
            st.metric(
                label=f"{selected_age} 'ë…ì„œë¥¼ ì¢‹ì•„í•¨' ë¹„ìœ¨",
                value="ë°ì´í„° ì—†ìŒ"
            )

    st.markdown("---")

    # íƒ­ êµ¬ì„±
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "ì—°ë ¹ëŒ€ë³„ ë…ì„œëŸ‰",
        "ì¼ë…ì„œì‹œê°„ ë¶„í¬",
        "ë…ì„œ ì„ í˜¸ë„",
        "ë…ì„œ ì¥ì• ìš”ì¸",
        "ìš”ì•½ ì¸ì‚¬ì´íŠ¸"
    ])

    # -----------------------------------
    # íƒ­ 1: ì—°ë ¹ëŒ€ë³„ ë…ì„œëŸ‰
    # -----------------------------------
    with tab1:
        st.subheader("ì—°ë ¹ëŒ€ë³„ ì—°ê°„ ë…ì„œëŸ‰ ë³€í™” (ì „ì²´ í‰ê·  ê¸°ì¤€)")

        fig1 = px.line(
            read_amount,
            x="ì—°ë„",
            y="ì—°ê°„_ë…ì„œëŸ‰(ê¶Œ)",
            color="ì—°ë ¹ëŒ€",
            markers=True,
            title=None
        )
        fig1.update_layout(legend_title_text="ì—°ë ¹ëŒ€")
        st.plotly_chart(fig1, use_container_width=True)

        st.markdown(f"""
        - **{selected_age}**ì— í•´ë‹¹í•˜ëŠ” ì—°ë ¹ëŒ€: **{amt_age_label}**
        - 2019ë…„ ëŒ€ë¹„ 2021ë…„ì— ë…ì„œëŸ‰ì´ ì–´ë–»ê²Œ ë³€í–ˆëŠ”ì§€ í™•ì¸í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        """)

    # -----------------------------------
    # íƒ­ 2: ì¼ë…ì„œì‹œê°„ ë¶„í¬
    # -----------------------------------
    with tab2:
        st.subheader("ì—°ë ¹ëŒ€ë³„ 1ì¼ í‰ê·  ë…ì„œì‹œê°„ ë° ë¶„í¬")

        # 1ì¼ í‰ê·  ë…ì„œì‹œê°„ ë§‰ëŒ€ê·¸ë˜í”„
        fig2 = px.bar(
            read_time,
            x="ì—°ë ¹ëŒ€",
            y="ì¼í‰ê· _ë…ì„œì‹œê°„(ë¶„)",
            title="ì—°ë ¹ëŒ€ë³„ 1ì¼ í‰ê·  ë…ì„œì‹œê°„(ë¶„)"
        )
        st.plotly_chart(fig2, use_container_width=True)

        st.markdown("### ì„ íƒ ì—°ë ¹ëŒ€ì˜ ì¼ë…ì„œì‹œê°„ ë¶„í¬")

        if not latest_time_row.empty:
            time_dist_cols = [
                "30ë¶„_ë¯¸ë§Œ(%)",
                "1ì‹œê°„_ë¯¸ë§Œ(%)",
                "2ì‹œê°„_ë¯¸ë§Œ(%)",
                "3ì‹œê°„_ë¯¸ë§Œ(%)",
                "4ì‹œê°„_ë¯¸ë§Œ(%)",
                "5ì‹œê°„_ë¯¸ë§Œ(%)",
                "5ì‹œê°„_ì´ìƒ(%)"
            ]
            dist = latest_time_row.melt(
                value_vars=time_dist_cols,
                var_name="êµ¬ê°„",
                value_name="ë¹„ìœ¨(%)"
            )
            fig3 = px.bar(
                dist,
                x="êµ¬ê°„",
                y="ë¹„ìœ¨(%)",
                title=f"{selected_age} ì¼ë…ì„œì‹œê°„ êµ¬ê°„ë³„ ë¹„ìœ¨"
            )
            st.plotly_chart(fig3, use_container_width=True)

            with st.expander("í•´ì„ ì˜ˆì‹œ"):
                st.write(f"""
                - {selected_age}ì˜ 1ì¼ í‰ê·  ë…ì„œì‹œê°„ì€ **{latest_time_row['ì¼í‰ê· _ë…ì„œì‹œê°„(ë¶„)'].iloc[0]:.1f}ë¶„**ì…ë‹ˆë‹¤.
                - **ë¹„ë…ì„œìœ¨**ì´ {latest_time_row['ë¹„ë…ì„œìœ¨(%)'].iloc[0]:.1f}%ë¡œ, ìƒë‹¹ìˆ˜ê°€ í•˜ë£¨ì— ì „í˜€ ì±…ì„ ì½ì§€ ì•ŠìŠµë‹ˆë‹¤.
                - ì½ëŠ” ì‚¬ëŒë“¤ ì¤‘ì—ì„œë„ ëŒ€ë¶€ë¶„ì´ **30ë¶„~1ì‹œê°„ ë¯¸ë§Œ** êµ¬ê°„ì— ì§‘ì¤‘ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                """)

        else:
            st.info("ì„ íƒí•œ ì—°ë ¹ëŒ€ì— ëŒ€í•œ ì¼ë…ì„œì‹œê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    # -----------------------------------
    # íƒ­ 3: ë…ì„œ ì„ í˜¸ë„
    # -----------------------------------
    with tab3:
        st.subheader("ì—°ë ¹ëŒ€ë³„ 'ë…ì„œë¥¼ ì–¼ë§ˆë‚˜ ì¢‹ì•„í•˜ëŠ”ê°€' ë¶„í¬")

        # ì „ì²´ ì—°ë ¹ëŒ€ ë¹„êµ (stacked bar)
        fig4 = px.bar(
            genre_pref,
            x="ì—°ë ¹ëŒ€",
            y="ë¹„ìœ¨(%)",
            color="ì„ í˜¸ë„",
            barmode="stack",
            title="ì—°ë ¹ëŒ€ë³„ ë…ì„œ ì„ í˜¸ë„ ë¶„í¬"
        )
        st.plotly_chart(fig4, use_container_width=True)

        st.markdown(f"### {selected_age} ({AGE_MAP_GENRE[selected_age]})ì˜ ë…ì„œ ì„ í˜¸ë„")

        sub = genre_pref[genre_pref["ì—°ë ¹ëŒ€"] == genre_age_label]
        if not sub.empty:
            fig5 = px.pie(
                sub,
                values="ë¹„ìœ¨(%)",
                names="ì„ í˜¸ë„",
                hole=0.4,
                title=f"{selected_age} ë…ì„œ ì„ í˜¸ë„ ë„ë„› ì°¨íŠ¸"
            )
            st.plotly_chart(fig5, use_container_width=True)

            with st.expander("í•´ì„ ì˜ˆì‹œ"):
                st.write("""
                - 'ë§¤ìš° ì¢‹ì•„í•¨' + 'ì•½ê°„ ì¢‹ì•„í•¨' ë¹„ìœ¨ì´ ì–´ëŠ ì •ë„ì¸ì§€ì— ë”°ë¼
                  í•´ë‹¹ ì—°ë ¹ëŒ€ê°€ ë…ì„œë¥¼ **ì •ì„œì ìœ¼ë¡œ ì–¼ë§ˆë‚˜ ê¸ì •ì ìœ¼ë¡œ ëŠë¼ëŠ”ì§€** íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                - 20ëŒ€(20ëŒ€ ì´í•˜)ì˜ ê²½ìš°, 'ì¢‹ì•„í•¨' ë¹„ìœ¨ì´ ë†’ìœ¼ë©´ì„œë„ ì‹¤ì œ ë…ì„œì‹œê°„ì€ ì§§ë‹¤ë©´,
                  **ì‹œê°„/í™˜ê²½ ë¬¸ì œë¡œ ì¸í•´ ì ì¬ì ì¸ ë…ì„œ ìš•êµ¬ê°€ ì‹¤ì²œìœ¼ë¡œ ì´ì–´ì§€ì§€ ëª»í•˜ëŠ” ì„¸ëŒ€**ë¼ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                """)
        else:
            st.info("ì„ íƒí•œ ì—°ë ¹ëŒ€ì— ëŒ€í•œ ì„ í˜¸ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    # -----------------------------------
    # íƒ­ 4: ë…ì„œ ì¥ì• ìš”ì¸
    # -----------------------------------
    with tab4:
        st.subheader("ì—°ë ¹ëŒ€ë³„ ë…ì„œ ì¥ì• ìš”ì¸")

        if AGE_MAP_BARRIER.get(selected_age) is None:
            st.info("í˜„ì¬ íŒŒì¼ì—ëŠ” 20ëŒ€ ì´í•˜(=20ëŒ€) ë°ì´í„°ë§Œ í¬í•¨ë˜ì–´ ìˆì–´, ì´ ì—°ë ¹ëŒ€ì— ëŒ€í•´ì„œë§Œ ì¥ì• ìš”ì¸ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
        else:
            barrier_age_label = AGE_MAP_BARRIER[selected_age]
            sub_b = barrier[barrier["ì—°ë ¹ëŒ€"] == barrier_age_label]

            if not sub_b.empty:
                fig6 = px.bar(
                    sub_b,
                    x="ë¹„ìœ¨(%)",
                    y="ì¥ì• ìš”ì¸",
                    orientation="h",
                    title=f"{selected_age} ë…ì„œ ì¥ì• ìš”ì¸ ë¹„ìœ¨",
                )
                st.plotly_chart(fig6, use_container_width=True)

                with st.expander("í•´ì„ ì˜ˆì‹œ"):
                    st.write("""
                    - ê°€ì¥ ë¹„ìœ¨ì´ ë†’ì€ í•­ëª©ì´ ì´ ì—°ë ¹ëŒ€ì—ì„œ **ë…ì„œë¥¼ ê°€ë¡œë§‰ëŠ” í•µì‹¬ ìš”ì¸**ì…ë‹ˆë‹¤.
                    - ì˜ˆë¥¼ ë“¤ì–´, 'ì¼(ê³µë¶€) ë•Œë¬¸ì— ì‹œê°„ì´ ì—†ì–´ì„œ'ì™€ 'ì±… ì´ì™¸ì˜ ë§¤ì²´ë¥¼ ì´ìš©í•´ì„œ' í•­ëª©ì˜ ë¹„ìœ¨ì´ ë†’ë‹¤ë©´,
                      20ëŒ€ëŠ” **ë…ì„œë¥¼ ì‹«ì–´í•´ì„œê°€ ì•„ë‹ˆë¼, ì‹œê°„ê³¼ ë””ì§€í„¸ ê²½ìŸ í™˜ê²½ ë•Œë¬¸ì— ì±…ì„ ì„ íƒí•˜ê¸° ì–´ë ¤ìš´ ì„¸ëŒ€**ë¼ê³  í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    """)
            else:
                st.info("ì„ íƒí•œ ì—°ë ¹ëŒ€ì— ëŒ€í•œ ì¥ì• ìš”ì¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    # -----------------------------------
    # íƒ­ 5: ìš”ì•½ ì¸ì‚¬ì´íŠ¸
    # -----------------------------------
    with tab5:
        st.subheader("ìš”ì•½ ì¸ì‚¬ì´íŠ¸ (ë°œí‘œìš© ì •ë¦¬)")

        st.markdown(f"""
        ### 1. {selected_age}ì˜ ë…ì„œëŸ‰ê³¼ ì‹œê°„

        - ì—°ê°„ ë…ì„œëŸ‰(ì „ì²´ í‰ê·  ê¸°ì¤€, 2021ë…„)ì€ **{amt_age_label}** êµ¬ê°„ì—ì„œ ì–¼ë§ˆì¸ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - 1ì¼ í‰ê·  ë…ì„œì‹œê°„ì€ ì•½ **{latest_time_row['ì¼í‰ê· _ë…ì„œì‹œê°„(ë¶„)'].iloc[0]:.1f}ë¶„**ì´ê³ ,  
          ë¹„ë…ì„œìœ¨ì€ **{latest_time_row['ë¹„ë…ì„œìœ¨(%)'].iloc[0]:.1f}%** ìˆ˜ì¤€ì…ë‹ˆë‹¤.
        
        ### 2. ë…ì„œ ì„ í˜¸ë„

        - {selected_age}ëŠ” ê°ì •ì ìœ¼ë¡œ ë…ì„œë¥¼ ì–¼ë§ˆë‚˜ ì¢‹ì•„í•˜ëŠ”ì§€,  
          'ë§¤ìš° ì¢‹ì•„í•¨' + 'ì•½ê°„ ì¢‹ì•„í•¨' ë¹„ìœ¨ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - ë§Œì•½ **ë…ì„œë¥¼ ì¢‹ì•„í•˜ëŠ” ë¹„ìœ¨ì€ ë†’ì€ë° ì‹¤ì œ ë…ì„œì‹œê°„ì´ ì§§ë‹¤ë©´**,  
          ì´ ì„¸ëŒ€ëŠ” **ì‹œê°„/í™˜ê²½ ë¬¸ì œë¡œ ì¸í•´ ë…ì„œ ìš•êµ¬ë¥¼ ì‹¤ì²œí•˜ì§€ ëª»í•˜ëŠ” ì„¸ëŒ€**ì¼ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.

        ### 3. ë…ì„œ ì¥ì• ìš”ì¸ (20ëŒ€ ê¸°ì¤€)

        - 20ëŒ€(20ëŒ€ ì´í•˜)ì˜ ë…ì„œ ì¥ì• ìš”ì¸ì„ ë³´ë©´  
          **'ì¼(ê³µë¶€) ë•Œë¬¸ì— ì‹œê°„ì´ ì—†ì–´ì„œ', 'ì±… ì´ì™¸ì˜ ë§¤ì²´ë¥¼ ì´ìš©í•´ì„œ'** ê°™ì€ í•­ëª©ì˜ ë¹„ìœ¨ì´ ë†’ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
        - ì´ëŠ” 20ëŒ€ê°€ **ë…ì„œë¥¼ ì‹«ì–´í•´ì„œê°€ ì•„ë‹ˆë¼,  
          ê²½ìŸÂ·í•™ì—…Â·ë””ì§€í„¸ ì½˜í…ì¸  í™˜ê²½ ì†ì—ì„œ ì±…ì„ ì„ íƒí•˜ê¸° ì–´ë ¤ìš´ ì„¸ëŒ€**ë¼ëŠ” ì ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

        ### 4. ì¢…í•©ì ìœ¼ë¡œ ë³¸ 20ëŒ€ ë…ì„œì˜ ì˜ë¯¸

        - ë°ì´í„°ìƒ 20ëŒ€ëŠ”  
          **"ë…ì„œë¥¼ ì•ˆ í•˜ëŠ” ì„¸ëŒ€"ê°€ ì•„ë‹ˆë¼  
          "ë…ì„œë¥¼ í•  ì‹œê°„ì´ ë¶€ì¡±í•œ ì„¸ëŒ€"**ì— ê°€ê¹ìŠµë‹ˆë‹¤.
        - ë™ì‹œì— ìê¸°ê³„ë°œ/ê°ì •ê´€ë¦¬ ì¤‘ì‹¬ì˜ ë…ì„œ ì„ í˜¸ê°€ ê°•í•˜ë‹¤ë©´,  
          20ëŒ€ ë…ì„œëŠ” **ë¯¸ë˜ì— ëŒ€í•œ ë¶ˆì•ˆê³¼ ìê¸° íƒìƒ‰ì˜ ìš•êµ¬ê°€ ë°˜ì˜ëœ í™œë™**ìœ¼ë¡œ í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        """)



import os
st.write(os.listdir("."))
